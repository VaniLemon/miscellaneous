<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Filosophy Chatbot with Memory</title>
  <style>
    body { 
      font-family: Arial, sans-serif; 
      background: #f8f9fa; 
      padding: 20px; 
      max-width: 600px; 
      margin: auto; 
    }
    h2 { text-align: center; }
    #chat {
      border: 1px solid #ccc; 
      border-radius: 8px;
      background: white;
      padding: 10px; 
      height: 300px; 
      overflow-y: auto;
      margin-bottom: 10px;
    }
    #setupForm, #chatControls {
      display: flex; 
      flex-direction: column; 
      gap: 10px;
      margin-bottom: 20px;
    }
    input, button {
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 14px;
    }
    button {
      cursor: pointer;
      background-color: #007bff;
      color: white;
      border: none;
      transition: background 0.2s;
    }
    button:hover { background-color: #0056b3; }
    #chat p { margin: 5px 0; }
    #chat p strong { color: #007bff; }
    #chatControlsRow {
      display: flex;
      gap: 10px;
    }
    #userInput {
      flex-grow: 1;
    }
  </style>
</head>
<body>
  <h2>ğŸ§™â€â™‚ï¸ The Eud-AI-monia</h2>
  <h3>ğŸ§™â€â™‚ï¸ The conversation that will help you flourish.</h3>

  <!-- Step 1: Setup Form -->
  <form id="setupForm">

    <button type="submit">I am ready to flourish ğŸ‘Œ!</button>
  </form>

  <!-- Step 2: Chat Interface -->
  <div id="chat"></div>

  <div id="chatControls" style="display:none;">
    <div id="chatControlsRow">
      <input id="userInput" placeholder="Type your message..." />
      <button id="sendBtn">Send</button>
    </div>
    <button id="newChatBtn" style="background-color: #6c757d;">New Chat</button>
  </div>

  <script>
Â  Â  const chatDiv = document.getElementById('chat');
Â  Â  const setupForm = document.getElementById('setupForm');
Â  Â  const chatControls = document.getElementById('chatControls');
Â  Â  const userInput = document.getElementById('userInput');
Â  Â  const sendBtn = document.getElementById('sendBtn');
Â  Â  const newChatBtn = document.getElementById('newChatBtn');

    // --- CORREZIONE ---
    // 1. Definisci l'URL UNA SOLA VOLTA.
Â  Â  const webhookURL = "https://hook.eu2.make.com/ezaxfneqg6hsh0dx1a5roj3kz478xhvl";

    // 2. Rimuovi la dichiarazione "let webhookURL = '';"
Â  Â  let secret = '';
Â  Â  let chatHistory = [];
    // --- FINE CORREZIONE ---

Â  Â  const SYSTEM_GREETING = "Socra-tech: Hello, how do you feel today?";

Â  Â  // Initialize new chat
Â  Â  function initChat() {
Â  Â  Â  chatHistory = [SYSTEM_GREETING];
Â  Â  Â  chatDiv.innerHTML = '';
Â  Â  Â  addMessage('Socra-tech', 'Hello, how do you feel today?'); // Corretto "howdo"
Â  Â  }

Â  Â  // Handle setup form
Â  Â  setupForm.addEventListener('submit', e => {
Â  Â  Â  e.preventDefault();
      
      // --- CORREZIONE ---
      // 3. Rimuovi la dichiarazione e il controllo dell'URL.
      //    Non sono necessari perchÃ© l'URL Ã¨ giÃ  definito e corretto.
      // --- FINE CORREZIONE ---

Â  Â  Â  setupForm.style.display = 'none';
Â  Â  Â  chatControls.style.display = 'flex';
Â  Â  Â  initChat();
Â  Â  });

Â  Â  // Handle "Send" button
Â  Â  sendBtn.addEventListener('click', sendMessage);
Â  Â  userInput.addEventListener('keypress', e => {
Â  Â  Â  if (e.key === 'Enter') sendMessage();
Â  Â  });

Â  Â  // Handle "New Chat" button
Â  Â  newChatBtn.addEventListener('click', () => {
Â  Â  Â  initChat();
Â  Â  Â  addMessage('System', 'ğŸ†• New chat started.');
Â  
   });

Â  Â  // Send message to Make.com
Â  Â  async function sendMessage() {
Â  Â  Â  const message = userInput.value.trim();
Â  Â  Â  if (!message) return;

Â  Â  Â  addMessage('User', message);
Â  Â  Â  userInput.value = '';

Â  Â  Â  // Update chat history in the desired format
Â  Â  Â  chatHistory.push(`User: ${message}`);

Â  Â  Â  const formattedConversation = chatHistory.join('\n');

Â  Â  Â  try {
Â  Â  Â  Â  const headers = { 'Content-Type': 'application/json' };
Â  Â  Â  Â  if (secret) headers['X-Secret-Key'] = secret;

        // Questa funzione ora userÃ  la "const webhookURL" globale
Â  Â  Â  Â  const response = await fetch(webhookURL, { 
Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  headers,
Â  Â  Â  Â  Â  body: JSON.stringify({ message: formattedConversation })
Â  Â  Â  Â  });

Â  Â  Â  Â  if (!response.ok) {
Â  Â  Â  Â  Â  // Se ricevi ancora 405, Ã¨ un problema di CORS in Make.com
Â  Â  Â  Â  Â  throw new Error(`Server returned ${response.status}`);
Â  Â  Â  Â  }

Â  Â  Â  Â  const data = await response.json();
Â  Â  Â  Â  const reply = data.reply || JSON.stringify(data);

Â  Â  Â  Â  // Format AI reply: render newlines and bold properly
Â  Â  Â  Â  const replyText = reply
Â  Â  Â  Â  Â  .replace(/\\n/g, '<br>')
Â  Â  Â  Â  Â  .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

Â  Â  Â  Â  addMessage('Customer Support', replyText);
Â  Â  Â  Â  chatHistory.push(`Customer Support: ${reply}`); // keep raw text in history
Â  Â  Â  
     } catch (err) {
Â  Â  Â  Â  addMessage('Error', err.message);
Â  Â  Â  }
Â  Â  }

Â  Â  // Utility: add message to the chat window
Â  Â  function addMessage(sender, text) {
Â  Â  Â  const msg = document.createElement('p');
Â  Â  Â  msg.innerHTML = `<strong>${sender}:</strong> ${text}`;
Â  Â  Â  chatDiv.appendChild(msg);
Â  Â  Â  chatDiv.scrollTop = chatDiv.scrollHeight;
Â  Â  }
</script>
</body>
</html>
